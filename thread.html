<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スレッド詳細</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .comment { margin: 10px 0; padding: 5px; }
    .meta { font-size: 0.9em; color: #555; }
    .anchor { color: blue; text-decoration: underline; cursor: pointer; }
  </style>
  <script>
    if (!localStorage.getItem("wakakusa_logged_in")) {
      location.href = "login.html";
    }
  </script>
</head>
<body>
  <div class="topbar"><button onclick="logout()">ログアウト</button></div>
  <h1>スレッド</h1>
  <div id="threadContent"></div>
  <hr>
  <input type="text" id="name" placeholder="名前（省略可）">
  <textarea id="comment" placeholder="コメント"></textarea>
  <button onclick="postComment()">書き込む</button>
  <div id="comments"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = "https://ghgnpbunnjzuopcxocqa.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdoZ25wYnVubmp6dW9wY3hvY3FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0MzA2MjIsImV4cCI6MjA2NzAwNjYyMn0.dgaTQXunx3__argTQar8qMpX6dQlqC7LZGlcdloz8NY";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const threadId = new URLSearchParams(location.search).get("id");

    function logout() {
      localStorage.removeItem("wakakusa_logged_in");
      location.href = "login.html";
    }

    async function loadThread() {
      const { data } = await supabase.from("threads").select("*").eq("id", threadId).single();
      if (data) {
        document.getElementById("threadContent").innerHTML =
          `<strong>${data.content}</strong><br><small>投稿者：${data.name}</small>`;
      }
    }

    async function postComment() {
      const name = document.getElementById("name").value || "名無しさん";
      const content = document.getElementById("comment").value.trim();
      if (!content) return;
      await supabase.from("comments").insert([{ thread_id: threadId, name, content }]);
      document.getElementById("comment").value = "";
      renderComments();
    }

    async function renderComments() {
      const { data } = await supabase.from("comments").select("*").eq("thread_id", threadId).order("created_at");
      const container = document.getElementById("comments");
      container.innerHTML = data.map((c, i) => {
        const html = (c.content || "").replace(/>>(\d+)/g, (match, num) =>
          `<span class="anchor" onclick="jumpTo(${num})">>>${num}</span>`
        );
        return `<div class="comment" id="c${i + 1}">
                  <div class="meta">${i + 1} 名前：${c.name}</div>
                  <div>${html}</div>
                </div>`;
      }).join("");
    }

    function jumpTo(num) {
      const target = document.getElementById("c" + num);
      if (target) {
        target.scrollIntoView({ behavior: "smooth" });
        target.style.backgroundColor = "#ffffcc";
        setTimeout(() => target.style.backgroundColor = "", 1000);
      }
    }

    loadThread();
    renderComments();
  </script>
</body>
</html>
